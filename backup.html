<script>
  (async () => {
    let config = await fetch("/config.json");
    let { home_assistant_access_token } = await config.json();

    window.home_assistant_access_token = home_assistant_access_token;

    let statesUrl = "http://192.168.178.35:8123/api/states";

    let states = await fetch(statesUrl, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${window.home_assistant_access_token}`,
        "Content-Type": "application/json",
      },
    });

    states = await states.json();

    const scenes = states.filter((state) => state.entity_id.includes("scene"));

    document
      .querySelector("home-assistant-scenes")
      .setAttribute("scenes", JSON.stringify(scenes));

    const switches = states.filter((state) =>
      state.entity_id.includes("switch")
    );
  })();

  class HomeAssistantScenes extends HTMLElement {
    constructor() {
      super();

      this.template = document.getElementById("home-assistant-scene");
      this.attachShadow({ mode: "open" });

      this.url = "http://192.168.178.35:8123/api/services/scene/turn_on";
    }

    init() {
      this.scenes = JSON.parse(this.getAttribute("scenes"));
      this.render();
    }

    render() {
      this.scenes.map((scene) => {
        const template = this.template;

        const button = (template.content.querySelector("button").value =
          scene.entity_id);

        template.content.querySelector("[slot=name]").textContent =
          scene.attributes.friendly_name;

        this.shadowRoot.appendChild(template.content.cloneNode(true));
      });

      this.shadowRoot.addEventListener("click", (ev) => {
        this.submit(ev.target.closest("button").value);
      });
    }

    async submit(value) {
      let config = await fetch("/config.json");
      let { home_assistant_access_token } = await config.json();

      fetch(this.url, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${window.home_assistant_access_token}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ entity_id: value }),
      });
    }

    static get observedAttributes() {
      return ["scenes"];
    }

    attributeChangedCallback(name, oldValue, newValue) {
      this.init();
    }
  }

  customElements.define("home-assistant-scenes", HomeAssistantScenes);

  (async () => {
    let config = await fetch("/config.json");
    let { home_assistant_access_token } = await config.json();

    let statesUrl = "http://192.168.178.35:8123/api/states";

    let states = await fetch(statesUrl, {
      method: "GET",
      headers: {
        Authorization:
          "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiI5MjMzYmY5NjAyNDA0MTQ2YjFlMTJlNDNlNTgzNGVhNyIsImlhdCI6MTY2NDcyOTg3OCwiZXhwIjoxOTgwMDg5ODc4fQ.2AdISngaa82eG2UpAbOWrq1oC6eSYUCf6Lp6kCgZV2Q",
        "Content-Type": "application/json",
      },
    });
    states = await states.json();

    const scenes = states.filter((state) => state.entity_id.includes("scene"));

    // console.log(scenes);

    const switches = states.filter((state) =>
      state.entity_id.includes("switch")
    );

    // console.log(switches);
  })();

  // let postUrl = "http://192.168.178.35:8123/api/services/scene/turn_on";

  // fetch(postUrl, {
  //   method: "POST",
  //   headers: {
  //     Authorization:
  //       "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiI5MjMzYmY5NjAyNDA0MTQ2YjFlMTJlNDNlNTgzNGVhNyIsImlhdCI6MTY2NDcyOTg3OCwiZXhwIjoxOTgwMDg5ODc4fQ.2AdISngaa82eG2UpAbOWrq1oC6eSYUCf6Lp6kCgZV2Q",
  //     "Content-Type": "application/json",
  //   },
  //   body: JSON.stringify({ entity_id: "scene.gute_nacht" }),
  // });
</script>
